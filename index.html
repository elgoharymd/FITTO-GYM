<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FITTO GYM - نظام الإدارة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #e0e7ff;
            --secondary-color: #3f37c9;
            --success-color: #10b981;
            --success-light: #d1fae5;
            --danger-color: #ef4444;
            --danger-light: #fee2e2;
            --warning-color: #f59e0b;
            --warning-light: #fef3c7;
            --info-color: #3b82f6;
            --info-light: #dbeafe;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --gray-color: #6b7280;
            --border-radius: 0.75rem;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --glow-effect: 0 0 15px rgba(67, 97, 238, 0.3);
            --profit-color: #7c3aed;
            --profit-light: #ede9fe;
            --daily-profit-color: #3a7bed;
            --daily-profit-light: #e9f4fe;
            --neon-blue: #00f2ff;
            --neon-pink: #ff00ff;
            --neon-green: #00ff9d;
            --glass-effect: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #f5f7fa, #e4e8f0);
            color: var(--dark-color);
            line-height: 1.6;
            scroll-behavior: smooth;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            transition: var(--transition);
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: fadeInDown 0.8s ease;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.9), rgba(63, 55, 201, 0.9));
        }

        .header::before {
            content: "";
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(135deg, 
                rgba(67, 97, 238, 0.8), 
                rgba(63, 55, 201, 0.8));
            z-index: -1;
            filter: blur(15px);
            border-radius: var(--border-radius);
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .logo {
            width: 120px;
            height: 120px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
            transition: var(--transition);
        }

        .logo:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
        }

        .logo::after {
            content: "";
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            animation: pulse 2s infinite;
            pointer-events: none;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 10px;
        }

        .club-name {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(45deg);
            transition: var(--transition);
            opacity: 0;
        }

        .btn:hover::after {
            opacity: 1;
            top: -20%;
            left: -20%;
        }

        .btn i {
            margin-left: 0.5rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            min-width: 35px;
            height: 35px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-sm i {
            margin: 0;
        }

        .btn-danger {
            background-color: var(--danger-color);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background-color: #dc2626;
            box-shadow: 0 8px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-warning {
            background-color: var(--warning-color);
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            background-color: #d97706;
            box-shadow: 0 8px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-success {
            background-color: var(--success-color);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background-color: #059669;
            box-shadow: 0 8px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-info {
            background-color: var(--info-color);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        .btn-info:hover {
            background-color: #2563eb;
            box-shadow: 0 8px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-profit {
            background-color: var(--profit-color);
            box-shadow: 0 4px 10px rgba(124, 58, 237, 0.3);
        }

        .btn-profit:hover {
            background-color: #6d28d9;
            box-shadow: 0 8px 15px rgba(124, 58, 237, 0.4);
        }

        .btn-daily-profit {
            background-color: var(--daily-profit-color);
            box-shadow: 0 4px 10px rgba(58, 123, 237, 0.3);
        }

        .btn-daily-profit:hover {
            background-color: #2563eb;
            box-shadow: 0 8px 15px rgba(58, 123, 237, 0.4);
        }

        .btn-light {
            background-color: var(--light-color);
            color: var(--dark-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-light:hover {
            background-color: #e5e7eb;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            box-shadow: none;
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Form Section */
        .form-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
            transition: all 0.5s ease;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
        }

        .form-section.active {
            max-height: 2000px;
            opacity: 1;
            margin-bottom: 2rem;
            overflow: visible;
            animation: fadeInUp 0.5s ease;
        }

        .form-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, 
                var(--success-color), 
                var(--primary-color));
            box-shadow: 0 2px 5px rgba(76, 201, 240, 0.5);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .form-section h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .form-group {
            margin-bottom: 1rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            font-family: 'Tajawal', sans-serif;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            background-color: var(--light-color);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2), inset 0 1px 3px rgba(0, 0, 0, 0.05);
            outline: none;
            background-color: white;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Search Box - Improved */
        .search-container {
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            background: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .search-box-container {
            flex: 1;
            position: relative;
            min-width: 200px;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem 1.5rem 0.75rem 3rem;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            box-shadow: var(--box-shadow);
            background-color: var(--light-color);
        }

        .search-box:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
            background-color: white;
        }

        .search-icon {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-type-toggle {
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            background-color: var(--light-color);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .search-type-toggle:hover {
            background-color: #e5e7eb;
        }

        .search-type-toggle.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Accordion Styles */
        .accordion {
            margin-bottom: 2rem;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        .accordion-item {
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-header {
            padding: 1.25rem 1.5rem;
            background-color: var(--light-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .accordion-header:hover {
            background-color: #f3f4f6;
        }

        .accordion-header.active {
            background-color: var(--primary-light);
        }

        .accordion-title {
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .accordion-icon {
            transition: var(--transition);
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-content-inner {
            padding: 1.5rem;
        }

        /* Table Section */
        .table-section {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 2rem;
            position: relative;
            animation: fadeIn 0.6s ease;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
        }

        .table-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, 
                var(--primary-color), 
                var(--secondary-color));
            box-shadow: 0 2px 5px rgba(67, 97, 238, 0.5);
        }

        .table-section h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            max-height: 600px;
            overflow-y: auto;
        }

        .members-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .members-table th,
        .members-table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
        }

        .members-table th {
            background-color: #f9fafb;
            font-weight: 700;
            color: var(--dark-color);
            position: sticky;
            top: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .members-table tr {
            transition: var(--transition);
            position: relative;
        }

        .members-table tr:hover {
            background-color: #f9fafb;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            z-index: 1;
        }

        /* Status Styles */
        .status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .status-active {
            background-color: var(--success-light);
            color: var(--success-color);
        }

        .status-expired {
            background-color: var(--danger-light);
            color: var(--danger-color);
        }

        .status-paid {
            background-color: var(--success-light);
            color: var(--success-color);
        }

        .status-unpaid {
            background-color: var(--danger-light);
            color: var(--danger-color);
        }

        .status-icon {
            margin-left: 0.5rem;
            font-size: 0.875rem;
        }

        /* Amount Styles */
        .amount {
            font-weight: 600;
        }

        .amount-remaining {
            color: var(--success-color);
        }

        .amount-due {
            color: var(--danger-color);
        }

        /* Stats Cards */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-card.active-members:hover {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        .stat-card.expired-members:hover {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        .stat-card.profit-card:hover {
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.2);
        }

        .stat-card.daily-profit-card:hover {
            box-shadow: 0 0 20px rgba(58, 123, 237, 0.2);
        }

        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--primary-color);
            box-shadow: 0 2px 5px rgba(67, 97, 238, 0.5);
        }

        .stat-card.active-members::before {
            background: var(--success-color);
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.5);
        }

        .stat-card.expired-members::before {
            background: var(--danger-color);
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.5);
        }

        .stat-card.profit-card::before {
            background: var(--profit-color);
            box-shadow: 0 2px 5px rgba(124, 58, 237, 0.5);
        }

        .stat-card.daily-profit-card::before {
            background: var(--daily-profit-color);
            box-shadow: 0 2px 5px rgba(58, 123, 237, 0.5);
        }

        .stat-title {
            font-size: 1rem;
            color: var(--gray-color);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card.active-members .stat-value {
            color: var(--success-color);
        }

        .stat-card.expired-members .stat-value {
            color: var(--danger-color);
        }

        .stat-card.profit-card .stat-value {
            color: var(--profit-color);
        }

        .stat-card.daily-profit-card .stat-value {
            color: var(--daily-profit-color);
        }

        .stat-change {
            font-size: 0.875rem;
            color: var(--gray-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background-color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            overflow: hidden;
            flex-wrap: wrap;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab:hover {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .tab::after {
            content: "";
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            transform: scaleX(0);
            transition: var(--transition);
        }

        .tab:hover::after {
            transform: scaleX(1);
        }

        .tab.active::after {
            transform: scaleX(1);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast i {
            margin-left: 0.5rem;
        }

        .toast.error {
            background-color: var(--danger-color);
        }

        .toast.warning {
            background-color: var(--warning-color);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        /* Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            min-width: 200px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--glass-border);
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dropdown-item:hover {
            background-color: var(--light-color);
        }

        .dropdown-divider {
            height: 1px;
            background-color: #e5e7eb;
            margin: 0.25rem 0;
        }

        /* Payments Section */
        .payments-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
        }

        .payments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .payments-title {
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .payments-table {
            width: 100%;
            border-collapse: collapse;
        }

        .payments-table th,
        .payments-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
        }

        .payments-table th {
            background-color: #f9fafb;
            font-weight: 700;
            color: var(--dark-color);
            position: sticky;
            top: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .payments-table tr:hover {
            background-color: #f9fafb;
        }

        /* Member Card Styles */
        .member-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid #e5e7eb;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
        }

        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .member-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--primary-color);
            box-shadow: 0 2px 5px rgba(67, 97, 238, 0.5);
        }

        .member-card.active::before {
            background: var(--success-color);
        }

        .member-card.expired::before {
            background: var(--danger-color);
        }

        .member-card .member-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .member-card .member-info-item {
            display: flex;
            flex-direction: column;
        }

        .member-card .member-info-label {
            font-size: 0.875rem;
            color: var(--gray-color);
            margin-bottom: 0.25rem;
        }

        .member-card .member-info-value {
            font-weight: 600;
        }

        .member-card .member-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Neon Glow Effects */
        .neon-border {
            position: relative;
            z-index: 1;
        }

        .neon-border::after {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: var(--border-radius);
            background: linear-gradient(45deg, 
                var(--neon-blue), 
                var(--neon-pink), 
                var(--neon-green));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .neon-border:hover::after {
            opacity: 0.7;
            animation: neonGlow 1.5s infinite alternate;
        }

        /* Main Menu */
        .main-menu {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .main-menu-btn {
            position: relative;
            overflow: hidden;
        }

        .main-menu-btn::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            transform: scaleX(0);
            transition: var(--transition);
        }

        .main-menu-btn:hover::after {
            transform: scaleX(1);
        }

        /* Financial Reports Section */
        .financial-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            display: none;
            opacity: 0;
            max-height: 0;
            transition: all 0.5s ease;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
        }

        .financial-section.active {
            display: block;
            max-height: 2000px;
            opacity: 1;
            animation: fadeInUp 0.5s ease;
        }

        .financial-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, 
                var(--profit-color), 
                var(--daily-profit-color));
            box-shadow: 0 2px 5px rgba(124, 58, 237, 0.5);
        }

        .financial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .financial-title {
            color: var(--profit-color);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .financial-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .financial-stat {
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
        }

        .financial-stat-title {
            font-size: 1rem;
            color: var(--gray-color);
            margin-bottom: 0.5rem;
        }

        .financial-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--profit-color);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
        }

        .chart-title {
            text-align: center;
            color: var(--profit-color);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .financial-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .financial-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            max-height: 500px;
            overflow-y: auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
        }

        .financial-table {
            width: 100%;
            border-collapse: collapse;
        }

        .financial-table th,
        .financial-table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
        }

        .financial-table th {
            background-color: #f9fafb;
            font-weight: 700;
            color: var(--dark-color);
            position: sticky;
            top: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .financial-table tr:hover {
            background-color: #f9fafb;
        }

        .day-profit {
            font-weight: 600;
            color: var(--success-color);
        }

        .day-members {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Stats Toggle Button */
        .toggle-stats-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 999;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .toggle-stats-btn:hover {
            transform: scale(1.1);
            background-color: var(--secondary-color);
        }

        /* Hidden Stats Section */
        .hidden-stats {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--glass-border);
        }

        .hidden-stats.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* Member ID */
        .member-id {
            font-size: 0.75rem;
            color: var(--gray-color);
            margin-top: 0.25rem;
        }

        /* Real-time update indicator */
        .update-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .update-indicator.show {
            opacity: 1;
        }

        .update-indicator i {
            animation: spin 1s linear infinite;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(67, 97, 238, 0.3); }
            50% { box-shadow: 0 0 20px rgba(67, 97, 238, 0.5); }
            100% { box-shadow: 0 0 5px rgba(67, 97, 238, 0.3); }
        }

        @keyframes neonGlow {
            from {
                filter: blur(2px) brightness(1);
            }
            to {
                filter: blur(4px) brightness(1.2);
            }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .glowing {
            animation: glow 2s infinite;
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        /* Responsive Adjustments */
        @media (max-width: 1200px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                padding: 1.5rem;
            }
            
            .club-name {
                font-size: 1.6rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 992px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .stats-section, .financial-stats {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .club-name {
                font-size: 1.4rem;
            }
            
            .logo {
                width: 100px;
                height: 100px;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.875rem;
            }
            
            .form-section {
                padding: 1.5rem;
            }
            
            .members-table th,
            .members-table td {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
            
            .stats-section, .financial-stats {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .financial-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }

        @media (max-width: 576px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 0.75rem;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
            }
            
            .tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
                gap: 0.25rem;
            }
            
            .btn-sm {
                width: 100%;
            }
            
            .main-menu {
                flex-direction: column;
            }
            
            .dropdown-menu {
                min-width: 100%;
            }
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .financial-section, .financial-section * {
                visibility: visible;
            }
            
            .financial-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                box-shadow: none;
                border: none;
                background: white;
            }
            
            .btn, .toggle-stats-btn, .search-container, .tabs {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <div class="logo glowing">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjneSenlewCewrAJE5xFQM0S3t46_lNzhbbi6TMsAwo4wQ8K0VSZeVAWobEmJkeFjj1zLf__qaoXhO2Vnc4-F6nhcSpnvP08FxfY0NjRlSKb12RG3gZfCzQUYfQEhyphenhyphen6JkBn36ck3QVBKv5yV3LCNo79164KauMIL8UOUhBjVfRAi1-202KpjlYNBOlmvOLC/s1080/IMG-20250810-WA0001.jpg" alt="شعار النادي" id="clubLogo">
                </div>
                <div class="club-name">FITTO GYM</div>
            </div>
            <h1>نظام إدارة المشتركين</h1>
            <p>إدارة كاملة لأعضاء النادي وتتبع الاشتراكات والأرباح</p>
        </header>

        <!-- مؤشر التحديث التلقائي -->
        <div id="updateIndicator" class="update-indicator">
            <i class="fas fa-sync-alt"></i>
            <span>جاري تحديث البيانات...</span>
        </div>

        <!-- القائمة الرئيسية -->
        <div class="main-menu">
            <button id="toggleFormBtn" class="btn main-menu-btn">
                <i class="fas fa-user-plus"></i> إضافة عضو جديد
            </button>
            
            <div class="dropdown">
                <button class="btn btn-daily-profit dropdown-toggle main-menu-btn" id="profitsDropdown">
                    <i class="fas fa-coins"></i> إدارة الأرباح <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu" id="profitsMenu">
                    <div class="dropdown-item" id="addDailyProfitBtn">
                        <i class="fas fa-plus-circle"></i> إضافة ربح يومي
                    </div>
                    <div class="dropdown-item" id="viewDailyProfitsBtn">
                        <i class="fas fa-list"></i> عرض الأرباح اليومية
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" id="recalculateBtn">
                        <i class="fas fa-calculator"></i> إعادة حساب الأموال
                    </div>
                    <div class="dropdown-item" id="clearPaymentsBtn">
                        <i class="fas fa-trash"></i> حذف جميع الأموال
                    </div>
                </div>
            </div>
            
            <div class="dropdown">
                <button class="btn btn-info dropdown-toggle main-menu-btn" id="systemDropdown">
                    <i class="fas fa-cog"></i> إعدادات النظام <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu" id="systemMenu">
                    <div class="dropdown-item" id="backupBtn">
                        <i class="fas fa-database"></i> نسخ احتياطي
                    </div>
                    <div class="dropdown-item" id="restoreBtn">
                        <i class="fas fa-undo"></i> استعادة نسخة
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" id="settingsBtn">
                        <i class="fas fa-sliders-h"></i> الإعدادات
                    </div>
                    <div class="dropdown-item" id="telegramSetupBtn">
                        <i class="fab fa-telegram"></i> إعدادات التليجرام
                    </div>
                </div>
            </div>
            
            <button id="toggleFinancialBtn" class="btn btn-profit main-menu-btn">
                <i class="fas fa-chart-line"></i> التقارير المالية
            </button>
        </div>

        <!-- قسم التقارير المالية -->
        <section id="financialSection" class="financial-section">
            <div class="financial-header">
                <h2 class="financial-title">
                    <i class="fas fa-chart-pie"></i>
                    <span>التقارير المالية الشهرية</span>
                </h2>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline" id="printFinancialBtn">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                    <button class="btn btn-sm btn-outline" id="exportFinancialBtn">
                        <i class="fas fa-file-export"></i> تصدير البيانات
                    </button>
                </div>
            </div>
            
            <div class="financial-stats">
                <div class="financial-stat">
                    <div class="financial-stat-title">إجمالي الأرباح الشهرية</div>
                    <div class="financial-stat-value" id="monthlyProfitTotal">0 E.G</div>
                </div>
                <div class="financial-stat">
                    <div class="financial-stat-title">متوسط الأرباح اليومية</div>
                    <div class="financial-stat-value" id="averageDailyProfit">0 E.G</div>
                </div>
                <div class="financial-stat">
                    <div class="financial-stat-title">أعلى ربح يومي</div>
                    <div class="financial-stat-value" id="highestDailyProfit">0 E.G</div>
                </div>
                <div class="financial-stat">
                    <div class="financial-stat-title">عدد المشتركين الجدد</div>
                    <div class="financial-stat-value" id="newMembersCount">0</div>
                </div>
                <div class="financial-stat">
                    <div class="financial-stat-title">إجمالي المدفوعات</div>
                    <div class="financial-stat-value" id="totalPaymentsAmount">0 E.G</div>
                </div>
                <div class="financial-stat">
                    <div class="financial-stat-title">إجمالي الأرباح اليومية</div>
                    <div class="financial-stat-value" id="totalDailyProfits">0 E.G</div>
                </div>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">الأرباح اليومية خلال الشهر الحالي</h3>
                <canvas id="profitChart"></canvas>
            </div>
            
            <div class="financial-details">
                <div class="financial-table-container">
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>اليوم</th>
                                <th>التاريخ</th>
                                <th>المبلغ المحصل</th>
                                <th>عدد المشتركين الجدد</th>
                                <th>المصادر</th>
                            </tr>
                        </thead>
                        <tbody id="financialDetails">
                            <!-- سيتم ملء هذا القسم بالبيانات من Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- قسم الإحصائيات المخفية -->
        <div id="hiddenStats" class="hidden-stats">
            <div class="stats-section">
                <div class="stat-card active-members">
                    <h3 class="stat-title">المشتركين النشطين</h3>
                    <div class="stat-value" id="activeMembersCount">0</div>
                    <div class="stat-change">اشتراكات سارية المفعول</div>
                </div>
                <div class="stat-card expired-members">
                    <h3 class="stat-title">المشتركين المنتهية اشتراكاتهم</h3>
                    <div class="stat-value" id="expiredMembersCount">0</div>
                    <div class="stat-change">بحاجة إلى تجديد</div>
                </div>
                <div class="stat-card profit-card">
                    <h3 class="stat-title">إجمالي الأرباح</h3>
                    <div class="stat-value" id="totalProfit">0 E.G</div>
                    <div class="stat-change">إجمالي المبالغ المحصلة</div>
                </div>
                <div class="stat-card daily-profit-card">
                    <h3 class="stat-title">الأرباح اليومية</h3>
                    <div class="stat-value" id="dailyProfit">0 E.G</div>
                    <div class="stat-change">المبالغ المحصلة اليوم</div>
                </div>
            </div>
        </div>

        <!-- زر عرض/إخفاء الإحصائيات -->
        <button id="toggleStatsBtn" class="toggle-stats-btn">
            <i class="fas fa-chart-bar"></i>
        </button>

        <!-- نموذج إضافة عضو جديد -->
        <section id="addMemberSection" class="form-section">
            <h2><i class="fas fa-user-edit"></i> نموذج إدارة العضو</h2>
            <form id="memberForm" class="form-grid">
                <input type="hidden" id="memberId">
                
                <div class="form-group">
                    <label for="memberName"><i class="fas fa-user"></i> اسم العضو</label>
                    <input type="text" id="memberName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="phoneNumber"><i class="fas fa-phone"></i> رقم الهاتف</label>
                    <input type="tel" id="phoneNumber" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="memberCode"><i class="fas fa-id-card"></i> كود العضو</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="memberCode" class="form-control" readonly>
                        <button type="button" id="generateCodeBtn" class="btn btn-sm btn-info">
                            <i class="fas fa-sync-alt"></i> توليد
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="subscriptionMonths"><i class="fas fa-calendar-alt"></i> مدة الاشتراك (شهور)</label>
                    <select id="subscriptionMonths" class="form-control" required>
                        <option value="1">1 شهر</option>
                        <option value="2">2 شهر</option>
                        <option value="3">3 شهور</option>
                        <option value="4">4 شهور</option>
                        <option value="5">5 شهور</option>
                        <option value="6">6 شهور</option>
                        <option value="7">7 شهور</option>
                        <option value="8">8 شهور</option>
                        <option value="9">9 شهور</option>
                        <option value="10">10 شهور</option>
                        <option value="11">11 شهر</option>
                        <option value="12">12 شهر (سنة)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="startDate"><i class="fas fa-calendar-alt"></i> تاريخ بداية الاشتراك</label>
                    <input type="date" id="startDate" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="endDate"><i class="fas fa-calendar-times"></i> تاريخ نهاية الاشتراك</label>
                    <input type="date" id="endDate" class="form-control" required readonly>
                </div>
                
                <div class="form-group">
                    <label for="subscriptionFee"><i class="fas fa-money-bill-wave"></i> رسوم الاشتراك الكاملة</label>
                    <input type="number" id="subscriptionFee" class="form-control" required min="0" step="any">
                </div>
                
                <div class="form-group">
                    <label for="amountPaid"><i class="fas fa-hand-holding-usd"></i> المبلغ المدفوع</label>
                    <input type="number" id="amountPaid" class="form-control" required min="0" step="any">
                </div>
                
                <div class="form-group">
                    <label for="paymentStatus"><i class="fas fa-check-circle"></i> حالة الدفع</label>
                    <select id="paymentStatus" class="form-control" required>
                        <option value="paid">مسدد</option>
                        <option value="unpaid">غير مسدد</option>
                    </select>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="notes"><i class="fas fa-sticky-note"></i> ملاحظات (اختياري)</label>
                    <textarea id="notes" class="form-control" placeholder="أي ملاحظات إضافية عن المشترك..."></textarea>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <button type="submit" class="btn" id="submitBtn" style="width: 100%;">
                        <i class="fas fa-save"></i> حفظ العضو
                    </button>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1; display: none;" id="cancelEditDiv">
                    <button type="button" class="btn btn-warning" id="cancelEditBtn" style="width: 100%;">
                        <i class="fas fa-times"></i> إلغاء التعديل
                    </button>
                </div>
            </form>
        </section>

        <!-- نموذج إضافة ربح يومي -->
        <section id="dailyProfitSection" class="form-section" style="display: none;">
            <h2><i class="fas fa-coins"></i> إضافة ربح يومي</h2>
            <form id="dailyProfitForm" class="form-grid">
                <div class="form-group">
                    <label for="dailyProfitDate"><i class="fas fa-calendar-day"></i> التاريخ</label>
                    <input type="date" id="dailyProfitDate" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="dailyProfitAmount"><i class="fas fa-money-bill-wave"></i> المبلغ</label>
                    <input type="number" id="dailyProfitAmount" class="form-control" required min="0" step="any">
                </div>
                
                <div class="form-group">
                    <label for="dailyProfitSource"><i class="fas fa-tags"></i> المصدر</label>
                    <input type="text" id="dailyProfitSource" class="form-control" placeholder="مثال: اشتراكات جديدة، تجديدات، إلخ...">
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="dailyProfitNotes"><i class="fas fa-sticky-note"></i> ملاحظات (اختياري)</label>
                    <textarea id="dailyProfitNotes" class="form-control" placeholder="أي ملاحظات إضافية عن الربح اليومي..."></textarea>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <button type="submit" class="btn btn-daily-profit" id="submitDailyProfitBtn" style="width: 100%;">
                        <i class="fas fa-save"></i> حفظ الربح اليومي
                    </button>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <button type="button" class="btn btn-warning" id="cancelDailyProfitBtn" style="width: 100%;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </section>

        <!-- نموذج إعدادات التليجرام -->
        <section id="telegramSettingsSection" class="form-section" style="display: none;">
            <h2><i class="fab fa-telegram"></i> إعدادات بوت التليجرام</h2>
            <form id="telegramSettingsForm" class="form-grid">
                <div class="form-group">
                    <label for="telegramBotToken"><i class="fas fa-key"></i> رمز البوت (Bot Token)</label>
                    <input type="text" id="telegramBotToken" class="form-control" placeholder="أدخل رمز بوت التليجرام">
                </div>
                
                <div class="form-group">
                    <label for="telegramChatId"><i class="fas fa-id-badge"></i> معرف المحادثة (Chat ID)</label>
                    <input type="text" id="telegramChatId" class="form-control" placeholder="أدخل معرف المحادثة">
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="telegramNotifications"><i class="fas fa-bell"></i> أنواع الإشعارات</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="notifyNewMembers" checked>
                            <span>إشعارات الأعضاء الجدد</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="notifyPayments" checked>
                            <span>إشعارات المدفوعات</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="notifyExpired" checked>
                            <span>إشعارات الاشتراكات المنتهية</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="notifyDailyProfits" checked>
                            <span>إشعارات الأرباح اليومية</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <button type="submit" class="btn btn-info" id="saveTelegramSettingsBtn" style="width: 100%;">
                        <i class="fas fa-save"></i> حفظ الإعدادات
                    </button>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <button type="button" class="btn btn-warning" id="testTelegramBtn" style="width: 100%;">
                        <i class="fas fa-paper-plane"></i> اختبار الإرسال
                    </button>
                </div>
                
                <div class="form-group" style="grid-column: 1 / -1;">
                    <button type="button" class="btn btn-danger" id="cancelTelegramSettingsBtn" style="width: 100%;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </section>
        
        <!-- قسم المدفوعات -->
        <div class="accordion">
            <div class="accordion-item">
                <div class="accordion-header" id="paymentsHeader">
                    <div class="accordion-title">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>إدارة المدفوعات</span>
                    </div>
                    <div class="accordion-icon">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <div class="accordion-content" id="paymentsContent">
                    <div class="accordion-content-inner">
                        <div class="payments-section">
                            <div class="payments-header">
                                <h3 class="payments-title">
                                    <i class="fas fa-coins"></i>
                                    <span>سجل المدفوعات</span>
                                </h3>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-success" id="addPaymentBtn">
                                        <i class="fas fa-plus"></i> إضافة دفعة
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="payments-table">
                                    <thead>
                                        <tr>
                                            <th>اسم العضو</th>
                                            <th>رقم الهاتف</th>
                                            <th>التاريخ</th>
                                            <th>المبلغ</th>
                                            <th>حالة الدفع</th>
                                            <th>ملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsList">
                                        <!-- سيتم ملء هذا القسم بالبيانات من Firebase -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- قوائم المشتركين -->
        <div class="accordion">
            <div class="accordion-item">
                <div class="accordion-header" id="membersHeader">
                    <div class="accordion-title">
                        <i class="fas fa-users"></i>
                        <span>إدارة المشتركين</span>
                    </div>
                    <div class="accordion-icon">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <div class="accordion-content" id="membersContent">
                    <div class="accordion-content-inner">
                        <div class="tabs">
                            <div class="tab active" data-tab="all">
                                <i class="fas fa-users"></i>
                                <span>جميع المشتركين</span>
                            </div>
                            <div class="tab" data-tab="active">
                                <i class="fas fa-user-check"></i>
                                <span>المشتركين النشطين</span>
                            </div>
                            <div class="tab" data-tab="expired">
                                <i class="fas fa-user-clock"></i>
                                <span>الاشتراكات المنتهية</span>
                            </div>
                        </div>
                        
                        <!-- صندوق البحث المحسن -->
                        <div class="search-container">
                            <div class="search-type-toggle active" id="searchByNameBtn">
                                <i class="fas fa-user"></i>
                                <span>البحث بالاسم</span>
                            </div>
                            <div class="search-type-toggle" id="searchByIdBtn">
                                <i class="fas fa-id-card"></i>
                                <span>البحث بالكود</span>
                            </div>
                            <div class="search-box-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="searchInput" class="search-box" placeholder="ابحث عن مشترك بالاسم أو رقم الهاتف...">
                            </div>
                        </div>
                        
                        <div class="tab-content active" id="all-members">
                            <div class="table-responsive">
                                <table class="members-table">
                                    <thead>
                                        <tr>
                                            <th>اسم العضو</th>
                                            <th>رقم الهاتف</th>
                                            <th>كود العضو</th>
                                            <th>بداية الاشتراك</th>
                                            <th>نهاية الاشتراك</th>
                                            <th>حالة الاشتراك</th>
                                            <th>حالة الدفع</th>
                                            <th>المبلغ المدفوع</th>
                                            <th>المبلغ المتبقي</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="membersList">
                                        <!-- سيتم ملء هذا القسم بالبيانات من Firebase -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="active-members">
                            <div class="table-responsive">
                                <table class="members-table">
                                    <thead>
                                        <tr>
                                            <th>اسم العضو</th>
                                            <th>رقم الهاتف</th>
                                            <th>كود العضو</th>
                                            <th>بداية الاشتراك</th>
                                            <th>نهاية الاشتراك</th>
                                            <th>حالة الدفع</th>
                                            <th>المبلغ المدفوع</th>
                                            <th>المبلغ المتبقي</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activeMembersList">
                                        <!-- سيتم ملء هذا القسم بالبيانات من Firebase -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="expired-members">
                            <div class="table-responsive">
                                <table class="members-table">
                                    <thead>
                                        <tr>
                                            <th>اسم العضو</th>
                                            <th>رقم الهاتف</th>
                                            <th>كود العضو</th>
                                            <th>بداية الاشتراك</th>
                                            <th>نهاية الاشتراك</th>
                                            <th>حالة الدفع</th>
                                            <th>المبلغ المدفوع</th>
                                            <th>المبلغ المتبقي</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expiredMembersList">
                                        <!-- سيتم ملء هذا القسم بالبيانات من Firebase -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">تمت العملية بنجاح</span>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBMJe0CVmxCrFthFmJEs5W_p1x3AFpFmHQ",
            authDomain: "moaz-a8190.firebaseapp.com",
            databaseURL: "https://moaz-a8190-default-rtdb.firebaseio.com",
            projectId: "moaz-a8190",
            storageBucket: "moaz-a8190.appspot.com",
            messagingSenderId: "839870478124",
            appId: "1:839870478124:web:904d5776d12a406e179e89",
            measurementId: "G-9S19GW5E26"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        
        // Initialize Realtime Database
        const database = firebase.database();
        const membersRef = database.ref('members');
        const paymentsRef = database.ref('payments');
        const dailyProfitsRef = database.ref('dailyProfits');
        const backupRef = database.ref('backups');
        const notificationsRef = database.ref('notifications');
        const settingsRef = database.ref('settings');

        // DOM elements
        const toggleFormBtn = document.getElementById('toggleFormBtn');
        const toggleFinancialBtn = document.getElementById('toggleFinancialBtn');
        const toggleStatsBtn = document.getElementById('toggleStatsBtn');
        const financialSection = document.getElementById('financialSection');
        const hiddenStats = document.getElementById('hiddenStats');
        const addMemberSection = document.getElementById('addMemberSection');
        const memberForm = document.getElementById('memberForm');
        const membersList = document.getElementById('membersList');
        const activeMembersList = document.getElementById('activeMembersList');
        const expiredMembersList = document.getElementById('expiredMembersList');
        const paymentsList = document.getElementById('paymentsList');
        const activeMembersCount = document.getElementById('activeMembersCount');
        const expiredMembersCount = document.getElementById('expiredMembersCount');
        const totalProfit = document.getElementById('totalProfit');
        const dailyProfitEl = document.getElementById('dailyProfit');
        const subscriptionMonths = document.getElementById('subscriptionMonths');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const subscriptionFeeInput = document.getElementById('subscriptionFee');
        const amountPaidInput = document.getElementById('amountPaid');
        const submitBtn = document.getElementById('submitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const cancelEditDiv = document.getElementById('cancelEditDiv');
        const memberIdInput = document.getElementById('memberId');
        const memberCodeInput = document.getElementById('memberCode');
        const generateCodeBtn = document.getElementById('generateCodeBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const clubLogo = document.getElementById('clubLogo');
        const searchInput = document.getElementById('searchInput');
        const paymentsHeader = document.getElementById('paymentsHeader');
        const paymentsContent = document.getElementById('paymentsContent');
        const dailyProfitSection = document.getElementById('dailyProfitSection');
        const dailyProfitForm = document.getElementById('dailyProfitForm');
        const dailyProfitDate = document.getElementById('dailyProfitDate');
        const dailyProfitAmount = document.getElementById('dailyProfitAmount');
        const dailyProfitSource = document.getElementById('dailyProfitSource');
        const dailyProfitNotes = document.getElementById('dailyProfitNotes');
        const submitDailyProfitBtn = document.getElementById('submitDailyProfitBtn');
        const cancelDailyProfitBtn = document.getElementById('cancelDailyProfitBtn');
        const backupBtn = document.getElementById('backupBtn');
        const recalculateBtn = document.getElementById('recalculateBtn');
        const clearPaymentsBtn = document.getElementById('clearPaymentsBtn');
        const restoreBtn = document.getElementById('restoreBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const viewDailyProfitsBtn = document.getElementById('viewDailyProfitsBtn');
        const profitsDropdown = document.getElementById('profitsDropdown');
        const profitsMenu = document.getElementById('profitsMenu');
        const systemDropdown = document.getElementById('systemDropdown');
        const systemMenu = document.getElementById('systemMenu');
        const printFinancialBtn = document.getElementById('printFinancialBtn');
        const exportFinancialBtn = document.getElementById('exportFinancialBtn');
        const monthlyProfitTotal = document.getElementById('monthlyProfitTotal');
        const averageDailyProfit = document.getElementById('averageDailyProfit');
        const highestDailyProfit = document.getElementById('highestDailyProfit');
        const newMembersCount = document.getElementById('newMembersCount');
        const financialDetails = document.getElementById('financialDetails');
        const profitChartCanvas = document.getElementById('profitChart');
        const telegramSettingsSection = document.getElementById('telegramSettingsSection');
        const telegramSettingsForm = document.getElementById('telegramSettingsForm');
        const telegramBotToken = document.getElementById('telegramBotToken');
        const telegramChatId = document.getElementById('telegramChatId');
        const saveTelegramSettingsBtn = document.getElementById('saveTelegramSettingsBtn');
        const testTelegramBtn = document.getElementById('testTelegramBtn');
        const cancelTelegramSettingsBtn = document.getElementById('cancelTelegramSettingsBtn');
        const notifyNewMembers = document.getElementById('notifyNewMembers');
        const notifyPayments = document.getElementById('notifyPayments');
        const notifyExpired = document.getElementById('notifyExpired');
        const notifyDailyProfits = document.getElementById('notifyDailyProfits');
        const telegramSetupBtn = document.getElementById('telegramSetupBtn');
        const updateIndicator = document.getElementById('updateIndicator');
        const searchByNameBtn = document.getElementById('searchByNameBtn');
        const searchByIdBtn = document.getElementById('searchByIdBtn');
        const addPaymentBtn = document.getElementById('addPaymentBtn');
        const totalPaymentsAmount = document.getElementById('totalPaymentsAmount');
        const totalDailyProfits = document.getElementById('totalDailyProfits');

        // متغيرات التطبيق
        let isEditMode = false;
        let currentMemberId = null;
        let allMembers = [];
        let allPayments = [];
        let dailyProfits = [];
        let totalProfitAmount = 0;
        let dailyProfitTotal = 0;
        let backupInterval;
        let profitCheckInterval;
        let profitChart = null;
        let currentMonthData = [];
        let usedCodes = new Set();
        let telegramNotificationInterval;
        let searchType = 'name'; // 'name' or 'id'
        let telegramSettings = {
            botToken: '',
            chatId: '',
            notifyNewMembers: true,
            notifyPayments: true,
            notifyExpired: true,
            notifyDailyProfits: true
        };

        // توليد كود عشوائي فريد من 4 إلى 8 أرقام
        function generateUniqueCode() {
            const minLength = 4;
            const maxLength = 8;
            const length = Math.floor(Math.random() * (maxLength - minLength + 1)) + minLength;
            
            let code;
            let attempts = 0;
            const maxAttempts = 100;
            
            do {
                code = '';
                for (let i = 0; i < length; i++) {
                    code += Math.floor(Math.random() * 10);
                }
                attempts++;
                
                if (attempts >= maxAttempts) {
                    // إذا فشلنا في توليد كود فريد بعد عدة محاولات، نضيف بادئة زمنية
                    code = Date.now().toString().slice(-length);
                    break;
                }
            } while (usedCodes.has(code));
            
            usedCodes.add(code);
            return code;
        }

        // تحديث قائمة الأكواد المستخدمة
        function updateUsedCodes() {
            usedCodes.clear();
            allMembers.forEach(member => {
                if (member.code) {
                    usedCodes.add(member.code);
                }
            });
        }

        // إدارة القوائم المنسدلة
        profitsDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
            profitsMenu.classList.toggle('show');
            systemMenu.classList.remove('show');
        });

        systemDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
            systemMenu.classList.toggle('show');
            profitsMenu.classList.remove('show');
        });

        document.addEventListener('click', function() {
            profitsMenu.classList.remove('show');
            systemMenu.classList.remove('show');
        });

        // Accordion functionality
        paymentsHeader.addEventListener('click', () => {
            paymentsHeader.classList.toggle('active');
            const content = paymentsContent;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });

        membersHeader.addEventListener('click', () => {
            membersHeader.classList.toggle('active');
            const content = membersContent;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });

        // Open members accordion by default
        membersHeader.classList.add('active');
        membersContent.style.maxHeight = membersContent.scrollHeight + "px";

        // عرض/إخفاء قسم التقارير المالية
        toggleFinancialBtn.addEventListener('click', function() {
            financialSection.classList.toggle('active');
            
            if (financialSection.classList.contains('active')) {
                toggleFinancialBtn.innerHTML = '<i class="fas fa-times"></i> إغلاق التقارير';
                financialSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                updateFinancialReport();
            } else {
                toggleFinancialBtn.innerHTML = '<i class="fas fa-chart-line"></i> التقارير المالية';
            }
        });

        // عرض/إخفاء قسم الإحصائيات
        toggleStatsBtn.addEventListener('click', function() {
            hiddenStats.classList.toggle('active');
        });

        // عرض/إخفاء نموذج الإضافة
        toggleFormBtn.addEventListener('click', function() {
            addMemberSection.classList.toggle('active');
            
            if (addMemberSection.classList.contains('active')) {
                toggleFormBtn.innerHTML = '<i class="fas fa-times"></i> إغلاق النموذج';
                addMemberSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                toggleFormBtn.innerHTML = '<i class="fas fa-user-plus"></i> إضافة عضو جديد';
                cancelEdit();
            }
        });

        // توليد كود عضو جديد
        generateCodeBtn.addEventListener('click', function() {
            memberCodeInput.value = generateUniqueCode();
        });

        // عرض/إخفاء نموذج الربح اليومي
        viewDailyProfitsBtn.addEventListener('click', function() {
            dailyProfitSection.style.display = 'block';
            dailyProfitSection.classList.add('active');
            dailyProfitSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            profitsMenu.classList.remove('show');
        });

        addDailyProfitBtn.addEventListener('click', function() {
            dailyProfitSection.style.display = 'block';
            dailyProfitSection.classList.add('active');
            
            // تعيين تاريخ اليوم كقيمة افتراضية
            const today = new Date().toISOString().split('T')[0];
            dailyProfitDate.value = today;
            
            dailyProfitSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            profitsMenu.classList.remove('show');
        });

        cancelDailyProfitBtn.addEventListener('click', function() {
            dailyProfitSection.style.display = 'none';
            dailyProfitSection.classList.remove('active');
            dailyProfitForm.reset();
        });

        // عرض/إخفاء إعدادات التليجرام
        telegramSetupBtn.addEventListener('click', function() {
            telegramSettingsSection.style.display = 'block';
            telegramSettingsSection.classList.add('active');
            telegramSettingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            systemMenu.classList.remove('show');
        });

        cancelTelegramSettingsBtn.addEventListener('click', function() {
            telegramSettingsSection.style.display = 'none';
            telegramSettingsSection.classList.remove('active');
            telegramSettingsForm.reset();
        });

        // حساب تاريخ نهاية الاشتراك عند تغيير تاريخ البدء أو عدد الأشهر
        function calculateEndDate() {
            const months = parseInt(subscriptionMonths.value);
            const startDate = new Date(startDateInput.value);
            
            if (!isNaN(startDate.getTime())) {
                const endDate = new Date(startDate);
                endDate.setMonth(startDate.getMonth() + months);
                endDateInput.value = endDate.toISOString().split('T')[0];
            }
        }

        // استماع لتغيير تاريخ البدء أو عدد الأشهر
        startDateInput.addEventListener('change', calculateEndDate);
        subscriptionMonths.addEventListener('change', calculateEndDate);

        // التحقق من أن المبلغ المدفوع لا يتجاوز رسوم الاشتراك
        amountPaidInput.addEventListener('input', function() {
            const subscriptionFee = parseFloat(subscriptionFeeInput.value) || 0;
            const amountPaid = parseFloat(this.value) || 0;
            
            if (amountPaid > subscriptionFee) {
                this.value = subscriptionFee;
                showToast('المبلغ المدفوع لا يمكن أن يتجاوز رسوم الاشتراك', 'warning');
            }
        });

        // عرض رسالة Toast
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = 'toast show';
            
            if (type === 'error') {
                toast.classList.add('error');
            } else if (type === 'warning') {
                toast.classList.add('warning');
            } else {
                toast.classList.remove('error', 'warning');
            }
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // إظهار مؤشر التحديث
        function showUpdateIndicator() {
            updateIndicator.classList.add('show');
            setTimeout(() => {
                updateIndicator.classList.remove('show');
            }, 2000);
        }

        // إرسال إشعار عبر بوت التليجرام
        async function sendTelegramNotification(message) {
            if (!telegramSettings.botToken || !telegramSettings.chatId) {
                console.warn('إعدادات التليجرام غير مكتملة');
                return;
            }
            
            try {
                const url = `https://api.telegram.org/bot${telegramSettings.botToken}/sendMessage`;
                const params = {
                    chat_id: telegramSettings.chatId,
                    text: message,
                    parse_mode: 'HTML'
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                if (!data.ok) {
                    console.error('فشل إرسال الإشعار عبر التليجرام:', data);
                }
                
                // حفظ الإشعار في قاعدة البيانات
                notificationsRef.push({
                    message: message,
                    type: 'telegram',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: data.ok ? 'success' : 'failed'
                });
                
                return data.ok;
            } catch (error) {
                console.error('حدث خطأ أثناء إرسال الإشعار:', error);
                
                // حفظ الإشعار الفاشل في قاعدة البيانات
                notificationsRef.push({
                    message: message,
                    type: 'telegram',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'failed',
                    error: error.message
                });
                
                return false;
            }
        }

        // إضافة/تعديل عضو
        memberForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('memberName').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();
            const code = memberCodeInput.value.trim();
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const subscriptionFee = parseFloat(subscriptionFeeInput.value);
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const paymentStatus = document.getElementById('paymentStatus').value;
            const notes = document.getElementById('notes').value.trim();
            
            if (!name || !phone || !code || !startDate || !endDate || isNaN(subscriptionFee)) {
                showToast('الرجاء تعبئة جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (amountPaid > subscriptionFee) {
                showToast('المبلغ المدفوع لا يمكن أن يتجاوز رسوم الاشتراك', 'error');
                return;
            }
            
            const memberData = {
                name: name,
                phone: phone,
                code: code,
                startDate: startDate,
                endDate: endDate,
                subscriptionFee: subscriptionFee,
                amountPaid: amountPaid,
                paymentStatus: paymentStatus,
                notes: notes,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            submitBtn.innerHTML = '<div class="spinner"></div> جاري الحفظ...';
            submitBtn.disabled = true;
            
            if (isEditMode) {
                membersRef.child(currentMemberId).update(memberData)
                    .then(() => {
                        showToast('تم تعديل بيانات العضو بنجاح');
                        resetForm();
                        
                        // إرسال إشعار بالتعديل إذا كان مفعلاً
                        if (telegramSettings.notifyNewMembers) {
                            const notificationMsg = `تم تعديل بيانات العضو:\nالاسم: <b>${name}</b>\nرقم الهاتف: <code>${phone}</code>\nكود العضو: <code>${code}</code>`;
                            sendTelegramNotification(notificationMsg);
                        }
                    })
                    .catch(error => {
                        showToast('حدث خطأ أثناء تعديل العضو: ' + error.message, 'error');
                    })
                    .finally(() => {
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
                        submitBtn.disabled = false;
                    });
            } else {
                membersRef.push({
                    ...memberData,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then((ref) => {
                    showToast('تم إضافة العضو الجديد بنجاح');
                    resetForm();
                    
                    if (amountPaid > 0) {
                        recordPayment(ref.key, name, phone, amountPaid, 'دفعة اشتراك جديدة', notes);
                    }
                    
                    // تحديث الربح اليومي عند إضافة عضو جديد مع دفعة
                    if (amountPaid > 0) {
                        updateDailyProfit(amountPaid, 'اشتراك جديد: ' + name);
                    }
                    
                    // تحديث التقارير المالية
                    updateFinancialReport();
                    
                    // إرسال إشعار بإضافة عضو جديد إذا كان مفعلاً
                    if (telegramSettings.notifyNewMembers) {
                        const notificationMsg = `تم إضافة عضو جديد:\nالاسم: <b>${name}</b>\nرقم الهاتف: <code>${phone}</code>\nكود العضو: <code>${code}</code>\nالمبلغ المدفوع: <b>${amountPaid} E.G</b>`;
                        sendTelegramNotification(notificationMsg);
                    }
                })
                .catch(error => {
                    showToast('حدث خطأ أثناء إضافة العضو: ' + error.message, 'error');
                })
                .finally(() => {
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> حفظ العضو';
                    submitBtn.disabled = false;
                });
            }
        });

        // إضافة ربح يومي
        dailyProfitForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const date = dailyProfitDate.value;
            const amount = parseFloat(dailyProfitAmount.value);
            const source = dailyProfitSource.value.trim() || 'غير محدد';
            const notes = dailyProfitNotes.value.trim();
            
            if (!date || isNaN(amount) || amount <= 0) {
                showToast('الرجاء إدخال تاريخ ومبلغ صحيح', 'error');
                return;
            }
            
            submitDailyProfitBtn.innerHTML = '<div class="spinner"></div> جاري الحفظ...';
            submitDailyProfitBtn.disabled = true;
            
            const profitData = {
                date: date,
                amount: amount,
                source: source,
                notes: notes,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            dailyProfitsRef.push(profitData)
                .then(() => {
                    showToast('تم إضافة الربح اليومي بنجاح');
                    dailyProfitForm.reset();
                    
                    // تعيين تاريخ اليوم كقيمة افتراضية
                    const today = new Date().toISOString().split('T')[0];
                    dailyProfitDate.value = today;
                    
                    // تحديث الربح اليومي
                    updateDailyProfit(amount, source);
                    
                    // تحديث التقارير المالية
                    updateFinancialReport();
                    
                    // إرسال إشعار بالربح اليومي إذا كان مفعلاً
                    if (telegramSettings.notifyDailyProfits) {
                        const notificationMsg = `تم إضافة ربح يومي جديد:\nالمبلغ: <b>${amount} E.G</b>\nالمصدر: <b>${source}</b>`;
                        sendTelegramNotification(notificationMsg);
                    }
                })
                .catch(error => {
                    showToast('حدث خطأ أثناء إضافة الربح اليومي: ' + error.message, 'error');
                })
                .finally(() => {
                    submitDailyProfitBtn.innerHTML = '<i class="fas fa-save"></i> حفظ الربح اليومي';
                    submitDailyProfitBtn.disabled = false;
                });
        });

        // تسجيل المدفوعات
        function recordPayment(memberId, memberName, phone, amount, source, notes) {
            const paymentData = {
                memberId: memberId,
                memberName: memberName,
                phone: phone,
                amount: amount,
                source: source,
                notes: notes || 'لا توجد ملاحظات',
                date: new Date().toISOString().split('T')[0],
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            paymentsRef.push(paymentData)
                .then(() => {
                    // تحديث إجمالي الأرباح
                    totalProfitAmount += amount;
                    totalProfit.textContent = `${totalProfitAmount} E.G`;
                    
                    // تحديث الربح اليومي
                    updateDailyProfit(amount, source);
                    
                    // إرسال إشعار بالدفعة إذا كان مفعلاً
                    if (telegramSettings.notifyPayments) {
                        const notificationMsg = `تم تسجيل دفعة جديدة:\nالاسم: <b>${memberName}</b>\nالمبلغ: <b>${amount} E.G</b>\nالمصدر: <b>${source}</b>`;
                        sendTelegramNotification(notificationMsg);
                    }
                })
                .catch(error => {
                    console.error('Error recording payment:', error);
                });
        }

        // تحديث الربح اليومي
        function updateDailyProfit(amount, source) {
            const today = new Date().toISOString().split('T')[0];
            
            dailyProfitTotal += amount;
            dailyProfitEl.textContent = `${dailyProfitTotal} E.G`;
            
            // تحديث إجمالي الأرباح
            totalProfitAmount += amount;
            totalProfit.textContent = `${totalProfitAmount} E.G`;
            
            // تحديث التقارير المالية
            updateFinancialReport();
        }

        // حساب الربح اليومي من البيانات
        function calculateDailyProfit() {
            const today = new Date().toISOString().split('T')[0];
            let todayProfit = 0;
            
            // حساب الأرباح من المدفوعات اليومية
            dailyProfits.forEach(profit => {
                if (profit.date === today) {
                    todayProfit += profit.amount;
                }
            });
            
            // حساب الأرباح من المشتركين الجدد اليوم
            allMembers.forEach(member => {
                const memberDate = new Date(member.startDate).toISOString().split('T')[0];
                if (memberDate === today && member.amountPaid > 0) {
                    todayProfit += member.amountPaid;
                }
            });
            
            dailyProfitTotal = todayProfit;
            dailyProfitEl.textContent = `${dailyProfitTotal} E.G`;
        }

        // حساب إجمالي الأرباح من البيانات
        function calculateTotalProfit() {
            let totalPayments = 0;
            let totalDaily = 0;
            
            // حساب من المدفوعات
            allPayments.forEach(payment => {
                totalPayments += payment.amount;
            });
            
            // حساب من الأرباح اليومية
            dailyProfits.forEach(profit => {
                totalDaily += profit.amount;
            });
            
            totalProfitAmount = totalPayments + totalDaily;
            totalProfit.textContent = `${totalProfitAmount.toFixed(2)} E.G`;
            totalPaymentsAmount.textContent = `${totalPayments.toFixed(2)} E.G`;
            totalDailyProfits.textContent = `${totalDaily.toFixed(2)} E.G`;
        }

        // تحديث التقارير المالية
        function updateFinancialReport() {
            showUpdateIndicator();
            
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            
            // فلترة البيانات للشهر الحالي
            currentMonthData = dailyProfits.filter(profit => {
                const profitDate = new Date(profit.date);
                return profitDate.getMonth() + 1 === currentMonth && profitDate.getFullYear() === currentYear;
            });
            
            // فلترة المشتركين الجدد لهذا الشهر
            const newMembersThisMonth = allMembers.filter(member => {
                const memberDate = new Date(member.startDate);
                return memberDate.getMonth() + 1 === currentMonth && memberDate.getFullYear() === currentYear;
            });
            
            // حساب الإحصائيات
            const monthlyProfit = currentMonthData.reduce((sum, profit) => sum + profit.amount, 0);
            const avgDailyProfit = monthlyProfit / currentDate.getDate();
            const maxDailyProfit = currentMonthData.length > 0 ? 
                Math.max(...currentMonthData.map(profit => profit.amount)) : 0;
            
            // تحديث العناصر في الصفحة
            monthlyProfitTotal.textContent = `${monthlyProfit.toFixed(2)} E.G`;
            averageDailyProfit.textContent = `${avgDailyProfit.toFixed(2)} E.G`;
            highestDailyProfit.textContent = `${maxDailyProfit.toFixed(2)} E.G`;
            newMembersCount.textContent = newMembersThisMonth.length;
            
            // إنشاء بيانات المخطط البياني
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            
            const profitsByDay = Array(daysInMonth).fill(0);
            const membersByDay = Array(daysInMonth).fill(0);
            
            currentMonthData.forEach(profit => {
                const day = new Date(profit.date).getDate();
                profitsByDay[day - 1] += profit.amount;
            });
            
            newMembersThisMonth.forEach(member => {
                const day = new Date(member.startDate).getDate();
                membersByDay[day - 1]++;
            });
            
            // تحديث المخطط البياني
            updateProfitChart(labels, profitsByDay, membersByDay);
            
            // تحديث الجدول التفصيلي
            updateFinancialDetailsTable(labels, profitsByDay, membersByDay);
        }
        
        // تحديث المخطط البياني
        function updateProfitChart(labels, profitsData, membersData) {
            const ctx = profitChartCanvas.getContext('2d');
            
            // إذا كان المخطط موجودًا بالفعل، قم بتدميره أولاً
            if (profitChart) {
                profitChart.destroy();
            }
            
            profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'الأرباح اليومية (E.G)',
                            data: profitsData,
                            backgroundColor: 'rgba(58, 123, 237, 0.7)',
                            borderColor: 'rgba(58, 123, 237, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'عدد المشتركين الجدد',
                            data: membersData,
                            backgroundColor: 'rgba(124, 58, 237, 0.7)',
                            borderColor: 'rgba(124, 58, 237, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'الأرباح اليومية (E.G)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'عدد المشتركين الجدد'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'أيام الشهر'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'الأرباح اليومية وعدد المشتركين الجدد خلال الشهر الحالي'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 0) {
                                        label += context.raw.toFixed(2) + ' E.G';
                                    } else {
                                        label += context.raw;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // تحديث الجدول التفصيلي
        function updateFinancialDetailsTable(labels, profitsData, membersData) {
            financialDetails.innerHTML = '';
            
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            
            // فلترة الأرباح اليومية لهذا الشهر
            const dailyProfitsThisMonth = dailyProfits.filter(profit => {
                const profitDate = new Date(profit.date);
                return profitDate.getMonth() + 1 === currentMonth && profitDate.getFullYear() === currentYear;
            });
            
            // فلترة المشتركين الجدد لهذا الشهر
            const newMembersThisMonth = allMembers.filter(member => {
                const memberDate = new Date(member.startDate);
                return memberDate.getMonth() + 1 === currentMonth && memberDate.getFullYear() === currentYear;
            });
            
            // تجميع المصادر لكل يوم
            const sourcesByDay = {};
            dailyProfitsThisMonth.forEach(profit => {
                const day = new Date(profit.date).getDate();
                if (!sourcesByDay[day]) {
                    sourcesByDay[day] = [];
                }
                sourcesByDay[day].push(profit.source);
            });
            
            // إضافة صف لكل يوم في الشهر
            labels.forEach((day, index) => {
                const dayProfit = profitsData[index];
                const dayMembers = membersData[index];
                const daySources = sourcesByDay[day] || [];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${day}</td>
                    <td>${day}/${currentMonth}/${currentYear}</td>
                    <td class="day-profit">${dayProfit.toFixed(2)} E.G</td>
                    <td class="day-members">${dayMembers}</td>
                    <td>${daySources.join('، ')}</td>
                `;
                
                financialDetails.appendChild(row);
            });
        }

        // طباعة التقرير المالي
        printFinancialBtn.addEventListener('click', function() {
            const printContent = financialSection.innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div style="direction: rtl; font-family: 'Tajawal', sans-serif; padding: 20px;">
                    <h1 style="text-align: center; color: #4361ee;">تقرير الأرباح الشهرية</h1>
                    <h2 style="text-align: center; color: #3f37c9;">${new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long' })}</h2>
                    ${printContent}
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
        });

        // تصدير البيانات المالية
        exportFinancialBtn.addEventListener('click', function() {
            const currentDate = new Date();
            const monthName = currentDate.toLocaleDateString('ar-EG', { month: 'long' });
            const year = currentDate.getFullYear();
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "تقرير الأرباح الشهرية - " + monthName + " " + year + "\n\n";
            csvContent += "اليوم,التاريخ,المبلغ المحصل,عدد المشتركين الجدد,المصادر\n";
            
            const rows = financialDetails.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => cell.textContent.replace(' E.G', '')).join(',');
                csvContent += rowData + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `financial_report_${monthName}_${year}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // إلغاء التعديل
        cancelEditBtn.addEventListener('click', cancelEdit);

        function cancelEdit() {
            isEditMode = false;
            currentMemberId = null;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> حفظ العضو';
            cancelEditDiv.style.display = 'none';
            resetForm();
            showToast('تم إلغاء التعديل');
        }

        // إعادة تعيين النموذج
        function resetForm() {
            memberForm.reset();
            memberIdInput.value = '';
            
            const today = new Date().toISOString().split('T')[0];
            startDateInput.value = today;
            
            document.getElementById('paymentStatus').value = 'paid';
            memberCodeInput.value = generateUniqueCode();
            calculateEndDate();
        }

        // تعديل عضو
        function editMember(memberId) {
            membersRef.child(memberId).once('value')
                .then(snapshot => {
                    const member = snapshot.val();
                    if (!member) return;
                    
                    memberIdInput.value = memberId;
                    document.getElementById('memberName').value = member.name;
                    document.getElementById('phoneNumber').value = member.phone;
                    memberCodeInput.value = member.code || generateUniqueCode();
                    
                    const startDate = new Date(member.startDate);
                    const endDate = new Date(member.endDate);
                    const monthsDiff = (endDate.getFullYear() - startDate.getFullYear()) * 12 + 
                                      (endDate.getMonth() - startDate.getMonth());
                    
                    subscriptionMonths.value = monthsDiff;
                    startDateInput.value = member.startDate;
                    endDateInput.value = member.endDate;
                    subscriptionFeeInput.value = member.subscriptionFee;
                    document.getElementById('amountPaid').value = member.amountPaid;
                    document.getElementById('paymentStatus').value = member.paymentStatus;
                    document.getElementById('notes').value = member.notes || '';
                    
                    isEditMode = true;
                    currentMemberId = memberId;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
                    cancelEditDiv.style.display = 'block';
                    
                    if (!addMemberSection.classList.contains('active')) {
                        addMemberSection.classList.add('active');
                        toggleFormBtn.innerHTML = '<i class="fas fa-times"></i> إغلاق النموذج';
                    }
                    
                    addMemberSection.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    showToast('حدث خطأ أثناء تحميل بيانات العضو: ' + error.message, 'error');
                });
        }

        // حذف عضو
        function deleteMember(memberId) {
            if (confirm('هل أنت متأكد من حذف هذا العضو؟ لا يمكن التراجع عن هذه العملية.')) {
                membersRef.child(memberId).remove()
                    .then(() => {
                        showToast('تم حذف العضو بنجاح');
                        
                        if (isEditMode && currentMemberId === memberId) {
                            cancelEdit();
                        }
                        
                        // إرسال إشعار بالحذف إذا كان مفعلاً
                        const member = allMembers.find(m => m.id === memberId);
                        if (member && telegramSettings.notifyNewMembers) {
                            const notificationMsg = `تم حذف العضو:\nالاسم: <b>${member.name}</b>\nكود العضو: <code>${member.code || 'غير محدد'}</code>`;
                            sendTelegramNotification(notificationMsg);
                        }
                    })
                    .catch(error => {
                        showToast('حدث خطأ أثناء حذف العضو: ' + error.message, 'error');
                    });
            }
        }

        // تجديد الاشتراك
        function renewSubscription(memberId) {
            membersRef.child(memberId).once('value')
                .then(snapshot => {
                    const member = snapshot.val();
                    if (!member) return;
                    
                    const endDate = new Date(member.endDate);
                    const today = new Date();
                    
                    const newEndDate = endDate < today 
                        ? new Date(today.setMonth(today.getMonth() + 1))
                        : new Date(endDate.setMonth(endDate.getMonth() + 1));
                    
                    const remainingAmount = member.subscriptionFee - member.amountPaid;
                    
                    const updateData = {
                        endDate: newEndDate.toISOString().split('T')[0],
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    if (remainingAmount > 0) {
                        if (confirm(`هناك مبلغ ${remainingAmount} E.G متبقٍ. هل تريد إضافته للفاتورة الجديدة؟`)) {
                            updateData.subscriptionFee = member.subscriptionFee + remainingAmount;
                        }
                    }
                    
                    return membersRef.child(memberId).update(updateData);
                })
                .then(() => {
                    showToast('تم تجديد الاشتراك بنجاح لمدة شهر إضافي');
                    
                    // إرسال إشعار بالتجديد إذا كان مفعلاً
                    const member = allMembers.find(m => m.id === memberId);
                    if (member && telegramSettings.notifyPayments) {
                        const notificationMsg = `تم تجديد اشتراك العضو:\nالاسم: <b>${member.name}</b>\nكود العضو: <code>${member.code || 'غير محدد'}</code>\nتاريخ النهاية الجديد: <b>${formatDate(newEndDate)}</b>`;
                        sendTelegramNotification(notificationMsg);
                    }
                })
                .catch(error => {
                    showToast('حدث خطأ أثناء تجديد الاشتراك: ' + error.message, 'error');
                });
        }

        // تبديل بين التبويبات
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}-members`).classList.add('active');
            });
        });

        // تنسيق التاريخ
        function formatDate(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'غير محدد';
            
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('ar-EG', options);
        }

        // البحث عن المشتركين
        function searchMembers(query) {
            const normalizedQuery = query.toLowerCase().trim();
            
            if (!normalizedQuery) {
                renderMembers(allMembers);
                return;
            }
            
            const filteredMembers = allMembers.filter(member => {
                if (searchType === 'name') {
                    return member.name.toLowerCase().includes(normalizedQuery) || 
                           member.phone.toLowerCase().includes(normalizedQuery);
                } else {
                    return member.code.toLowerCase().includes(normalizedQuery) || 
                           member.id.toLowerCase().includes(normalizedQuery);
                }
            });
            
            renderMembers(filteredMembers);
        }

        // تغيير نوع البحث
        searchByNameBtn.addEventListener('click', function() {
            searchType = 'name';
            searchByNameBtn.classList.add('active');
            searchByIdBtn.classList.remove('active');
            searchInput.placeholder = 'ابحث عن مشترك بالاسم أو رقم الهاتف...';
            searchMembers(searchInput.value);
        });

        searchByIdBtn.addEventListener('click', function() {
            searchType = 'id';
            searchByIdBtn.classList.add('active');
            searchByNameBtn.classList.remove('active');
            searchInput.placeholder = 'ابحث عن مشترك بالكود أو الرقم التعريفي...';
            searchMembers(searchInput.value);
        });

        // عرض المشتركين في الجداول
        function renderMembers(members) {
            membersList.innerHTML = '';
            activeMembersList.innerHTML = '';
            expiredMembersList.innerHTML = '';
            
            let activeCount = 0;
            let expiredCount = 0;
            const today = new Date();
            
            members.forEach(member => {
                const remainingAmount = member.subscriptionFee - member.amountPaid;
                const isPaid = member.paymentStatus === 'paid';
                const statusClass = isPaid ? 'status-paid' : 'status-unpaid';
                const statusIcon = isPaid ? 'fa-check-circle' : 'fa-times-circle';
                const amountClass = remainingAmount > 0 ? 'amount-due' : 'amount-remaining';
                const amountText = remainingAmount > 0 ? 
                    `${Math.abs(remainingAmount)} E.G (متبقي)` : 
                    `${Math.abs(remainingAmount)} E.G (زيادة)`;
                
                const endDate = new Date(member.endDate);
                const isActive = endDate >= today;
                const subscriptionStatusClass = isActive ? 'status-active' : 'status-expired';
                const subscriptionStatusIcon = isActive ? 'fa-check-circle' : 'fa-exclamation-circle';
                const subscriptionStatusText = isActive ? 'نشط' : 'منتهي';
                
                if (isActive) activeCount++;
                else expiredCount++;
                
                const row = document.createElement('tr');
                row.className = isActive ? 'active-member' : 'expired-member';
                row.innerHTML = `
                    <td>
                        <div class="member-name">${member.name}</div>
                        <div class="member-id">ID: ${member.id}</div>
                    </td>
                    <td>${member.phone}</td>
                    <td>${member.code || 'غير محدد'}</td>
                    <td>${formatDate(member.startDate)}</td>
                    <td>${formatDate(member.endDate)}</td>
                    <td>
                        <span class="status ${subscriptionStatusClass}">
                            ${subscriptionStatusText}
                            <i class="fas ${subscriptionStatusIcon} status-icon"></i>
                        </span>
                    </td>
                    <td>
                        <span class="status ${statusClass}">
                            ${isPaid ? 'مسدد' : 'غير مسدد'}
                            <i class="fas ${statusIcon} status-icon"></i>
                        </span>
                    </td>
                    <td class="amount">${member.amountPaid} E.G</td>
                    <td class="amount ${amountClass}">${amountText}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm neon-border" onclick="editMember('${member.id}')" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger neon-border" onclick="deleteMember('${member.id}')" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                            ${!isActive ? `<button class="btn btn-sm btn-success neon-border" onclick="renewSubscription('${member.id}')" title="تجديد">
                                <i class="fas fa-sync-alt"></i>
                            </button>` : ''}
                            ${member.notes ? `<button class="btn btn-sm btn-profit neon-border" onclick="showNotes('${member.id}')" title="عرض الملاحظات">
                                <i class="fas fa-sticky-note"></i>
                            </button>` : ''}
                        </div>
                    </td>
                `;
                
                membersList.appendChild(row);
                
                if (isActive) {
                    const activeRow = document.createElement('tr');
                    activeRow.className = 'active-member';
                    activeRow.innerHTML = `
                        <td>
                            <div class="member-name">${member.name}</div>
                            <div class="member-id">ID: ${member.id}</div>
                        </td>
                        <td>${member.phone}</td>
                        <td>${member.code || 'غير محدد'}</td>
                        <td>${formatDate(member.startDate)}</td>
                        <td>${formatDate(member.endDate)}</td>
                        <td>
                            <span class="status ${statusClass}">
                                ${isPaid ? 'مسدد' : 'غير مسدد'}
                                <i class="fas ${statusIcon} status-icon"></i>
                            </span>
                        </td>
                        <td class="amount">${member.amountPaid} E.G</td>
                        <td class="amount ${amountClass}">${amountText}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm neon-border" onclick="editMember('${member.id}')" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger neon-border" onclick="deleteMember('${member.id}')" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ${member.notes ? `<button class="btn btn-sm btn-profit neon-border" onclick="showNotes('${member.id}')" title="عرض الملاحظات">
                                    <i class="fas fa-sticky-note"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    `;
                    
                    activeMembersList.appendChild(activeRow);
                }
                else {
                    const expiredRow = document.createElement('tr');
                    expiredRow.className = 'expired-member';
                    expiredRow.innerHTML = `
                        <td>
                            <div class="member-name">${member.name}</div>
                            <div class="member-id">ID: ${member.id}</div>
                        </td>
                        <td>${member.phone}</td>
                        <td>${member.code || 'غير محدد'}</td>
                        <td>${formatDate(member.startDate)}</td>
                        <td>${formatDate(member.endDate)}</td>
                        <td>
                            <span class="status ${statusClass}">
                                ${isPaid ? 'مسدد' : 'غير مسدد'}
                                <i class="fas ${statusIcon} status-icon"></i>
                            </span>
                        </td>
                        <td class="amount">${member.amountPaid} E.G</td>
                        <td class="amount ${amountClass}">${amountText}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-success neon-border" onclick="renewSubscription('${member.id}')" title="تجديد">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn btn-sm neon-border" onclick="editMember('${member.id}')" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger neon-border" onclick="deleteMember('${member.id}')" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ${member.notes ? `<button class="btn btn-sm btn-profit neon-border" onclick="showNotes('${member.id}')" title="عرض الملاحظات">
                                    <i class="fas fa-sticky-note"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    `;
                    
                    expiredMembersList.appendChild(expiredRow);
                }
            });
            
            activeMembersCount.textContent = activeCount;
            expiredMembersCount.textContent = expiredCount;
        }

        // عرض المدفوعات
        function renderPayments() {
            paymentsList.innerHTML = '';
            
            allPayments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.memberName}</td>
                    <td>${payment.phone}</td>
                    <td>${formatDate(payment.date)}</td>
                    <td class="amount">${payment.amount} E.G</td>
                    <td>
                        <span class="status status-paid">
                            مسدد
                            <i class="fas fa-check-circle status-icon"></i>
                        </span>
                    </td>
                    <td>${payment.notes}</td>
                `;
                paymentsList.appendChild(row);
            });
        }

        // عرض ملاحظات المشترك
        function showNotes(memberId) {
            const member = allMembers.find(m => m.id === memberId);
            if (!member || !member.notes) return;
            
            alert(`ملاحظات عن المشترك ${member.name} (ID: ${memberId}):\n\n${member.notes}`);
        }

        // إنشاء نسخة احتياطية
        function createBackup() {
            const today = new Date();
            const backupDate = today.toISOString();
            const backupData = {
                members: allMembers,
                payments: allPayments,
                dailyProfits: dailyProfits,
                createdAt: backupDate
            };
            
            // حفظ نسخة في localStorage
            localStorage.setItem('gymMembersBackup', JSON.stringify(backupData));
            
            // حفظ نسخة في Firebase
            backupRef.push(backupData)
                .then(() => {
                    showToast('تم إنشاء نسخة احتياطية بنجاح');
                })
                .catch(error => {
                    showToast('حدث خطأ أثناء إنشاء النسخة الاحتياطية: ' + error.message, 'error');
                });
        }

        // استعادة النسخة الاحتياطية من localStorage
        function restoreFromLocalBackup() {
            const backup = localStorage.getItem('gymMembersBackup');
            if (!backup) return;
            
            try {
                const backupData = JSON.parse(backup);
                allMembers = backupData.members || [];
                allPayments = backupData.payments || [];
                dailyProfits = backupData.dailyProfits || [];
                
                renderMembers(allMembers);
                renderPayments();
                calculateTotalProfit();
                calculateDailyProfit();
                updateUsedCodes();
                
                showToast('تم تحميل النسخة الاحتياطية المحلية');
            } catch (error) {
                console.error('Error restoring from local backup:', error);
            }
        }

        // إعادة حساب جميع الأموال
        function recalculateAllPayments() {
            if (confirm('هل تريد إعادة حساب جميع الأموال المحصلة؟ سيتم تحديث الإحصائيات بناءً على البيانات الحالية.')) {
                calculateTotalProfit();
                calculateDailyProfit();
                updateFinancialReport();
                showToast('تم إعادة حساب جميع الأموال بنجاح');
            }
        }

        // حذف جميع سجلات المدفوعات
        function clearAllPayments() {
            if (confirm('هل أنت متأكد من حذف جميع سجلات المدفوعات؟ لا يمكن التراجع عن هذه العملية.')) {
                paymentsRef.remove()
                    .then(() => {
                        allPayments = [];
                        totalProfitAmount = 0;
                        totalProfit.textContent = '0 E.G';
                        renderPayments();
                        showToast('تم حذف جميع سجلات المدفوعات بنجاح');
                    })
                    .catch(error => {
                        showToast('حدث خطأ أثناء حذف سجلات المدفوعات: ' + error.message, 'error');
                    });
            }
        }

        // حفظ إعدادات التليجرام
        function saveTelegramSettings() {
            const settings = {
                botToken: telegramBotToken.value.trim(),
                chatId: telegramChatId.value.trim(),
                notifyNewMembers: notifyNewMembers.checked,
                notifyPayments: notifyPayments.checked,
                notifyExpired: notifyExpired.checked,
                notifyDailyProfits: notifyDailyProfits.checked
            };
            
            settingsRef.child('telegram').set(settings)
                .then(() => {
                    showToast('تم حفظ إعدادات التليجرام بنجاح');
                    loadTelegramSettings();
                })
                .catch(error => {
                    showToast('حدث خطأ أثناء حفظ الإعدادات: ' + error.message, 'error');
                });
        }

        // تحميل إعدادات التليجرام
        function loadTelegramSettings() {
            settingsRef.child('telegram').once('value')
                .then(snapshot => {
                    const settings = snapshot.val();
                    if (settings) {
                        telegramSettings = settings;
                        
                        telegramBotToken.value = settings.botToken || '';
                        telegramChatId.value = settings.chatId || '';
                        notifyNewMembers.checked = settings.notifyNewMembers !== false;
                        notifyPayments.checked = settings.notifyPayments !== false;
                        notifyExpired.checked = settings.notifyExpired !== false;
                        notifyDailyProfits.checked = settings.notifyDailyProfits !== false;
                    }
                })
                .catch(error => {
                    console.error('Error loading Telegram settings:', error);
                });
        }

        // اختبار إرسال إشعار عبر التليجرام
        function testTelegramNotification() {
            if (!telegramBotToken.value || !telegramChatId.value) {
                showToast('الرجاء إدخال رمز البوت ومعرف المحادثة', 'error');
                return;
            }
            
            const testMessage = 'هذا إشعار اختبار من نظام إدارة النادي الرياضي\nتم بنجاح ✅';
            
            sendTelegramNotification(testMessage)
                .then(success => {
                    if (success) {
                        showToast('تم إرسال إشعار الاختبار بنجاح');
                    } else {
                        showToast('فشل إرسال إشعار الاختبار', 'error');
                    }
                });
        }

        // تحديث قوائم المشتركين عند تغيير البيانات في Firebase
        membersRef.on('value', function(snapshot) {
            allMembers = [];
            
            snapshot.forEach(childSnapshot => {
                const member = childSnapshot.val();
                member.id = childSnapshot.key;
                allMembers.push(member);
            });
            
            renderMembers(allMembers);
            updateFinancialReport();
            updateUsedCodes();
            
            // التحقق من الاشتراكات المنتهية وإرسال إشعارات
            checkExpiredSubscriptions();
        });

        // تحديث المدفوعات عند تغيير البيانات في Firebase
        paymentsRef.on('value', function(snapshot) {
            allPayments = [];
            
            snapshot.forEach(childSnapshot => {
                const payment = childSnapshot.val();
                payment.id = childSnapshot.key;
                allPayments.push(payment);
            });
            
            renderPayments();
            calculateTotalProfit();
            updateFinancialReport();
        });

        // تحديث الأرباح اليومية
        dailyProfitsRef.on('value', function(snapshot) {
            dailyProfits = [];
            
            snapshot.forEach(childSnapshot => {
                const profit = childSnapshot.val();
                profit.id = childSnapshot.key;
                dailyProfits.push(profit);
            });
            
            calculateDailyProfit();
            calculateTotalProfit();
            updateFinancialReport();
        });

        // التحقق من الاشتراكات المنتهية وإرسال إشعارات
        function checkExpiredSubscriptions() {
            if (!telegramSettings.notifyExpired) return;
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const expiredMembers = allMembers.filter(member => {
                const endDate = new Date(member.endDate);
                return endDate < today;
            });
            
            const expiringSoonMembers = allMembers.filter(member => {
                const endDate = new Date(member.endDate);
                return endDate >= today && endDate <= tomorrow;
            });
            
            // إرسال إشعارات للاشتراكات المنتهية
            if (expiredMembers.length > 0) {
                const names = expiredMembers.map(m => m.name).join('، ');
                const notificationMsg = `تحذير: هناك <b>${expiredMembers.length}</b> اشتراكات منتهية\nالأسماء: <b>${names}</b>`;
                sendTelegramNotification(notificationMsg);
            }
            
            // إرسال إشعارات للاشتراكات التي ستنتهي قريباً
            if (expiringSoonMembers.length > 0) {
                const names = expiringSoonMembers.map(m => m.name).join('، ');
                const notificationMsg = `تنبيه: هناك <b>${expiringSoonMembers.length}</b> اشتراكات ستنتهي قريباً\nالأسماء: <b>${names}</b>`;
                sendTelegramNotification(notificationMsg);
            }
        }

        // البحث عند كتابة نص في صندوق البحث
        searchInput.addEventListener('input', function() {
            searchMembers(this.value);
        });

        // إنشاء نسخة احتياطية عند النقر على الزر
        backupBtn.addEventListener('click', createBackup);

        // إعادة حساب الأموال
        recalculateBtn.addEventListener('click', recalculateAllPayments);

        // حذف جميع المدفوعات
        clearPaymentsBtn.addEventListener('click', clearAllPayments);

        // استعادة النسخة الاحتياطية
        restoreBtn.addEventListener('click', function() {
            if (confirm('هل تريد استعادة النسخة الاحتياطية المحلية؟ سيتم استبدال البيانات الحالية.')) {
                restoreFromLocalBackup();
            }
        });

        // إعدادات النظام
        settingsBtn.addEventListener('click', function() {
            showToast('هذه الميزة قيد التطوير', 'warning');
        });

        // حفظ إعدادات التليجرام
        telegramSettingsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveTelegramSettings();
        });

        // اختبار إرسال إشعار التليجرام
        testTelegramBtn.addEventListener('click', testTelegramNotification);

        // إضافة دفعة جديدة
        addPaymentBtn.addEventListener('click', function() {
            const memberName = prompt('أدخل اسم العضو:');
            if (!memberName) return;
            
            const member = allMembers.find(m => m.name === memberName);
            if (!member) {
                showToast('لم يتم العثور على العضو', 'error');
                return;
            }
            
            const amount = parseFloat(prompt('أدخل مبلغ الدفعة:'));
            if (isNaN(amount) || amount <= 0) {
                showToast('المبلغ غير صحيح', 'error');
                return;
            }
            
            const source = prompt('أدخل مصدر الدفعة (اختياري):') || 'دفعة يدوية';
            const notes = prompt('أدخل ملاحظات (اختياري):') || 'لا توجد ملاحظات';
            
            recordPayment(member.id, member.name, member.phone, amount, source, notes);
        });

        // التحميل الأولي للصفحة
        document.addEventListener('DOMContentLoaded', function() {
            resetForm();
            
            const today = new Date().toISOString().split('T')[0];
            startDateInput.value = today;
            dailyProfitDate.value = today;
            calculateEndDate();
            
            // تعيين نوع البحث الافتراضي
            searchByNameBtn.classList.add('active');
            
            // استعادة النسخة الاحتياطية من localStorage إذا وجدت
            restoreFromLocalBackup();
            
            // تحميل إعدادات التليجرام
            loadTelegramSettings();
            
            // إنشاء نسخة احتياطية كل ساعة
            backupInterval = setInterval(createBackup, 60 * 60 * 1000);
            
            // مراجعة الربح اليومي كل دقيقة
            profitCheckInterval = setInterval(calculateDailyProfit, 60 * 1000);
            
            // التحقق من الاشتراكات المنتهية كل 6 ساعات
            telegramNotificationInterval = setInterval(checkExpiredSubscriptions, 6 * 60 * 60 * 1000);
            
            // جعل الدوال متاحة للاستدعاء من الأحداث المضمنة في HTML
            window.editMember = editMember;
            window.deleteMember = deleteMember;
            window.renewSubscription = renewSubscription;
            window.showNotes = showNotes;
        });

        // تنظيف الفواصل الزمنية عند إغلاق الصفحة
        window.addEventListener('beforeunload', function() {
            clearInterval(backupInterval);
            clearInterval(profitCheckInterval);
            clearInterval(telegramNotificationInterval);
        });
    </script>
</body>
</html>
